---
theme: light
title: データローダ
---

# データ ローダー

**データ ローダー** は、ビルド中にデータの静的スナップショットを生成します。たとえば、データ ローダーはデータベースをクエリして CSV データを出力したり、サーバー側でチャートをレンダリングして PNG イメージを出力したりします。


例えば、データローダーは、[USGS](https://earthquake.usgs.gov/earthquakes/feed/v1.0/geojson.php)から最近の地震データを取得するための、[curl](https://curl.se/)を呼び出す単純なシェルスクリプトでも作成できます。

```sh
curl https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/queaks.csv
```

データローダーは[ファイルベースのルーティング](#routing)を使用するので、このシェルスクリプトの名前を `data/quakes.csv.sh` とすると、ビルド時に `quakes.csv` ファイルが生成されます。クライアントからこのファイルにアクセスするには、[`FileAttachment`](./files)を使用します：


```js echo
FileAttachment("data/quakes.csv").csv()
```

より複雑な、データの取得・整形処理をnode.jsで書くこともできます。

以下の、データ・ローダーは、ダッシュボードのニーズにぴったり合うように[D3](./lib/d3)を使用して、各地震の_magnitude_、_longitude_、_latitude_を表す3つの列を持つ[CSV](./lib/csv)を出力します。

```js run=false echo
import {csvFormat} from "d3-dsv";

// USGSからGeoJSONを取得する
const response = await fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson");
if (!response.ok) throw new Error(`fetch failed: ${response.status}`);
const collection = await response.json();

// オブジェクトの配列に変換する
const features = collection.features.map((f) => ({
  magnitude: f.properties.mag,
  longitude: f.geometry.coordinates[0],
  latitude: f.geometry.coordinates[1]
}));

// 整形したcsvを標準出力に出力する
process.stdout.write(csvFormat(features));
```

上記のローダーの名前を`quakes.csv.js`にすると、クライアントから`quakes.csv`としてアクセスできます。：

```js echo
const quakes = FileAttachment("data/quakes.csv").csv({typed: true});
```

上記のデータ―ローダによって、データが最適な形に整形されたので[Observable Plot](./lib/plot)を使って地震データを地図上にプロットできます。：

```js
const world = await fetch(import.meta.resolve("npm:world-atlas/land-110m.json")).then((response) => response.json());
const land = topojson.feature(world, world.objects.land);
```

```js echo
Plot.plot({
  projection: {
    type: "orthographic",
    rotate: [110, -30]
  },
  marks: [
    Plot.graticule(),
    Plot.sphere(),
    Plot.geo(land, {stroke: "var(--theme-foreground-faint)"}),
    Plot.dot(quakes, {x: "longitude", y: "latitude", r: "magnitude", stroke: "#f43f5e"})
  ]
})
```

開発時のプレビューサーバーはデータローダーの出力が初めて必要になったときに自動的にデータローダーを実行し、結果を[キャッシュ](#caching)します。データローダーを編集すると、プレビューサーバーは自動的に再度データローダーを実行し、新しい結果をクライアントにプッシュします。

ビルド時は、データ―ローダーはデータの静的スナップショットを生成します。これにより、データが事前計算され、即座に提供されるため、クエリを毎回実行する必要がなくなります。データローダーは任意であり、JavaScript、Python、Rなど多様なプログラミング言語で記述可能です。複数ファイルのアーカイブ生成や、クライアント側でのデータアクセスもサポートされています。


## Archives

データローダーはZIPファイルのような複数ファイルのアーカイブを生成することができ、フレームワークは`FileAttachment`を使って個々のファイルをアーカイブから取り出すことができます。
以下のアーカイブ拡張子がサポートされています：

- `.zip` -  [ZIP](<https://en.wikipedia.org/wiki/ZIP_(file_format)>) フォーマット
- `.tar` -  [tarballs](<https://en.wikipedia.org/wiki/Tar_(computing)>) フォーマット
- `.tar.gz` and `.tgz` -  [compressed tarballs](https://en.wikipedia.org/wiki/Gzip) フォーマット

以下はクライアント側で 静的なzipファイル`lib/muybridge.zip` から画像を読み込む例です。

```js echo
FileAttachment("data/img/muybridge/deer.jpeg").image({width: 320, alt: "A deer"})
```

HTMLタグでもzipファイル内の画像を指定して表示することができます。

<img src="data/img/muybridge/deer.jpeg" width="320" alt="A deer">

```html run=false
<img src="data/img/muybridge/deer.jpeg" width="320" alt="A deer">
```

以下のデータローダー `quakes.zip.ts` は、[JSZip](https://stuk.github.io/jszip/) を使用して、`metadata.json` と `features.csv` という2つのファイルのZIPアーカイブを生成しています。

```js run=false
import {csvFormat} from "d3-dsv";
import JSZip from "jszip";

// USGSからGeoJSONを取得する
const response = await fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson");
if (!response.ok) throw new Error(`fetch failed: ${response.status}`);
const collection = await response.json();

//オブジェクトの配列に変換する
const features = collection.features.map((f) => ({
  magnitude: f.properties.mag,
  longitude: f.geometry.coordinates[0],
  latitude: f.geometry.coordinates[1]
}));

// ZIPアーカイブを標準出力に出力する
const zip = new JSZip();
zip.file("metadata.json", JSON.stringify(collection.metadata, null, 2));
zip.file("features.csv", csvFormat(features));
zip.generateNodeStream().pipe(process.stdout);
```

クライアント側でデータを読み込むには、`FileAttachment`を使います。：

```js run=false
const metadata = FileAttachment("quakes/metadata.json").json();
const features = FileAttachment("quakes/features.csv").csv({typed: true});
```

生成されるファイル名が事前にわからない場合は、zipファイル自体を指定してメタデータを取り出すこともできます。：

```js echo
const zip = FileAttachment("quakes.zip").zip();
const metadata = zip.then((zip) => zip.file("metadata.json").json());
```

他のファイルと同様に、生成されたアーカイブのファイルはプレビューでライブ表示され（対応するデータローダーが編集されると自動的に更新されます）、`FileAttachment`によって[静的に参照される](./files#static-analysis)場合にのみビルドに追加されます。


## Output

データローダーは、データを[標準出力](<https://en.wikipedia.org/wiki/Standard_streams#Standard_output_(stdout)>)に出力する必要があります。

## roging

データローダーは期待される出力(CSVなど)を生成することだけに責任があります。データローダー内で追加情報をログに記録したい場合は、[`console.warn`](https://developer.mozilla.org/en-US/docs/Web/API/console/warn) を使用して、必ず標準エラー出力にログを記録してください。そうしないと、ログは出力ファイルに含まれ、クライアントに送信されてしまいます。

[source code](https://github.com/shimizu/observable-framework-demo/blob/main/docs/8.data-loaders.md)